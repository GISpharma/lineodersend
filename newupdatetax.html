<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>

  <!-- Bootstrap & Tailwind -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
    crossorigin="anonymous"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />

  <!-- SweetAlert2 -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    #loading { display: none; }
    .results { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; }
    .result-item { padding: 5px; cursor: pointer; }
    .result-item:hover { background-color: #eee; }

/* 1. Override native appearance ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô checkbox */
input:not([type=checkbox]),
select {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

/* 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö/‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á/‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
input:not([type=checkbox]),
select {
  width: 100%;
  padding: 0.5rem 1rem;
  font-size: 1rem;
  line-height: 1.5;
  border: 1px solid #ccc;
  border-radius: 0.375rem;
  background-color: #fff;
  color: #333;
}

/* 3. ‡πÉ‡∏™‡πà‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <select> */
select {
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0l5 6 5-6H0z' fill='%23666'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  background-size: 0.6rem auto;
  padding-right: 2.5rem;
}

/* 4. Focus state */
input:not([type=checkbox]):focus,
select:focus {
  outline: none;
  border-color: #4285f4;
  box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.3);
}

/* 5. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô zoom ‡∏ö‡∏ô iOS */
html {
  font-size: 16px;
}


  </style>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
  <div class="container mx-auto p-2">
    <form id="myForm">
      <div class="bg-white p-2">
        <!-- hidden: order_id -->
        <div class="flex justify-start p-2 border-2 border-green-800 rounded-lg mb-4"  style="display: none;">
          <span class="input-group-text">OderID</span>
          <input type="text" id="keyInput" name="order_id"  required />
        </div>
        <!-- hidden: userId -->
        <div class="flex justify-start p-2 border border-green-800 rounded-lg mb-4"  style="display: none;">
          <span class="input-group-text">UserID</span>
          <input type="text" id="userId" name="userId" required />
        </div>
        <!-- displayName -->
        <div class="flex justify-start p-2  border-2 border-green-800 rounded-lg mb-4">
          <span class="text-black pt-3">üîî</span>
          <input
            type="text"
            id="displayName"
            name="displayName"
            class="bg-transparent border-none text-black ml-2 w-2/3"
            required
          />
        </div>

        <!-- top‚Äêrow inputs -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="sell_id" class="block mb-2 text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</label>
            <input type="number" name="sell_id" class="block w-full p-2 border rounded-md" required />
          </div>
          <div>
            <label for="category" class="block mb-2 text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            <select id="category" name="category" class="block w-full p-2 border rounded-md" required>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
              <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏¢‡∏≤">‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏¢‡∏≤</option>
              <option value="‡∏Ñ‡∏•‡∏µ‡∏ô‡∏¥‡∏Å">‡∏Ñ‡∏•‡∏µ‡∏ô‡∏¥‡∏Å</option>
              <option value="‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏£‡∏±‡∏ê">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏£‡∏±‡∏ê</option>
              <option value="‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô</option>
              <option value="‡∏£‡πâ‡∏≤‡∏ô/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏Ç‡∏≤‡∏¢‡∏™‡πà‡∏á">‡∏£‡πâ‡∏≤‡∏ô/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏Ç‡∏≤‡∏¢‡∏™‡πà‡∏á</option>
              <option value="‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</option>
            </select>
          </div>
          <div>
            <label for="ipo" class="block mb-2 text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</label>
            <input type="text" id="ipo" name="ipo" class="block w-full p-2 border rounded-md" />
          </div>
          <div>
            <label for="provinceInput" class="block mb-2 text-sm font-medium text-gray-700">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
            <input list="provinces" id="provinceInput" name="city" class="block w-full p-2 border rounded-md" required />
            <datalist id="provinces">
              <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"><option value="‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà"><option value="‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ">
              <!-- ‚Ä¶etc‚Ä¶ -->
            </datalist>
          </div>
        </div>

        <!-- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ + ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà -->
        <div class="mt-4">
          <label for="cust_nm" class="block mb-2 text-sm font-medium text-gray-700">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
          <input
            type="text"
            id="cust_nm"
            name="cust_nm"
            class="block w-full p-2 border rounded-md"
            required
          />
          <div class="mt-2 flex items-center">
            <input
              type="checkbox"
              id="newCustomer"
              name="newCustomer"
              value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà"
              class="form-checkbox h-4 w-4 text-green-600"
            />
            <label for="newCustomer" class="ml-2 text-gray-700">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</label>
          </div>
        </div>

        <!-- Order items placeholder -->
        <div id="orderItems" class="mt-4"></div>
        <div class="mt-4">
          <button
            type="button"
            class="btn border-2 border-green-800 text-green-700 p-2"
            onclick="addOrderItem()"
          >
          ‚ûï‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </button>
        </div>

        <!-- Total, credit, note, submit -->
        <div class="mt-4">
          <label for="FTotal" class="block mb-2 text-sm font-medium text-gray-700">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
          <input
            type="number"
            id="FTotal"
            name="FTotal"
            class="block w-full bg-gray-200 p-2 border rounded-md"
            readonly
          />
        </div>
        <div class="mt-4">
          <select name="credit" class="block w-full p-2 border rounded-md" required>
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
            <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
            <option value="7 ‡∏ß‡∏±‡∏ô">7 ‡∏ß‡∏±‡∏ô</option>
            <option value="30 ‡∏ß‡∏±‡∏ô">30 ‡∏ß‡∏±‡∏ô</option>
            <option value="60 ‡∏ß‡∏±‡∏ô">60 ‡∏ß‡∏±‡∏ô</option>
            <option value="90 ‡∏ß‡∏±‡∏ô">90 ‡∏ß‡∏±‡∏ô</option>
            <option value="120 ‡∏ß‡∏±‡∏ô">120 ‡∏ß‡∏±‡∏ô</option>
          </select>
        </div>
        <div class="mt-4">
          <textarea
            name="note"
            class="block w-full p-2 border rounded-md"
            placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
          ></textarea>
        </div>
        <div class="mt-4">
          <button
            id="submitButton"
            type="button"
            class="btn bg-green-800 border-2 border-green-700 text-white py-2 w-full hover:bg-green-600"
            onclick="submitForm()"
          >
            ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
        </div>
      </div>
    </form>
  </div>

  <script>
    // ---------- LIFF & Profile ----------
    window.onload = () => {
      initializeLiff();
      generateKeyAndDate();
    };

    async function initializeLiff() {
      await liff.init({ liffId: '2000460029-kvLNmnPE' });
      if (liff.isLoggedIn()) getUserProfile();
      else liff.login();
    }

    async function getUserProfile() {
      try {
        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;
        document.getElementById('displayName').value = profile.displayName;
      } catch (e) {
        console.error(e);
      }
    }

    // ---------- OrderID & Date ----------
    function generateKeyAndDate() {
      const rnd = Math.random().toString(36).substring(7);
      const d = new Date();
      const yy = String(d.getFullYear()).slice(-2);
      const mm = String(d.getMonth()+1).padStart(2,'0');
      document.getElementById('keyInput').value = `inv${yy}${mm}-${rnd}`;
    }

    // ---------- Dynamic Item List ----------
    const allItems = [
      "AMCARDIA 5", "AMCARDIA 10", "DICLO SR 100",
      "DOLONIL SR 100", "ENACE 10", /* ‚Ä¶etc‚Ä¶ */
    ];

    function addOrderItem() {
      const container = document.getElementById('orderItems');
      const card = document.createElement('div');
      card.className = 'bg-green-50 p-2 border-2 border-green-800 shadow-md rounded-lg mb-4 order-item';
      card.innerHTML = `
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</label>
            <input class="form-control w-full p-2 border rounded-md" name="item_nm[]" required />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
              <input type="number" name="quantity[]" class="form-control w-full p-2 border rounded-md" onchange="calculateAmount(this)" required />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏Ñ‡∏≤</label>
              <input type="number" name="price[]" class="form-control w-full p-2 border rounded-md" onchange="calculateAmount(this)" required />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-700">‡πÅ‡∏ñ‡∏°</label>
              <input type="number" name="give[]" class="form-control w-full p-2 border rounded-md" onchange="calculateAmount(this)" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-700">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
              <input type="number" name="dis[]" class="form-control w-full p-2 border rounded-md" onchange="calculateAmount(this)" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-700">‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</label>
              <input type="text" name="smp[]" class="form-control w-full p-2 border rounded-md"  />
              <span class="text-sm text-red-600">‡∏ï‡∏¢. ‡πÑ‡∏°‡πà‡∏°‡∏µ 3% 5% 7% 3‡∏ö‡∏≤‡∏ó 5‡∏ö‡∏≤‡∏ó 7‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
              <input type="number" name="amt[]" class="form-control bg-gray-200 w-full p-2 border rounded-md" readonly />
            </div>
            <div class="flex items-end">
              <button type="button" class="w-24 bg-red-200 border-2 border-red-500 p-2 text-red-900 font-bold rounded-md" onclick="removeOrderItem(this)">‚ùå ‡∏•‡∏ö</button>
            </div>
          </div>
        
      `;  
      container.appendChild(card);
      attachDatalist(card.querySelector('input[name="item_nm[]"]'));
    }

    function attachDatalist(inputEl) {
      const maxShow = 3;
      inputEl.addEventListener('input', () => {
        const val = inputEl.value.toLowerCase();
        const matches = allItems.filter(i=>i.toLowerCase().includes(val)).slice(0,maxShow);
        let dl = document.getElementById('datalist-items'); if(dl) dl.remove();
        if(matches.length){
          dl=document.createElement('datalist'); dl.id='datalist-items';
          matches.forEach(m=>dl.appendChild(new Option(m)));
          document.body.appendChild(dl);
          inputEl.setAttribute('list','datalist-items');
        } else inputEl.removeAttribute('list');
      });
    }

    function removeOrderItem(btn){ btn.closest('.order-item').remove(); calculateTotal(); }
    function calculateAmount(el){
      const card=el.closest('.order-item');
      const q=+card.querySelector('input[name="quantity[]"]').value||0;
      const p=+card.querySelector('input[name="price[]"]').value||0;
      card.querySelector('input[name="amt[]"]').value=q*p;
      calculateTotal();
    }
    function calculateTotal(){
      document.getElementById('FTotal').value=
        [...document.querySelectorAll('input[name="amt[]"]')]
        .reduce((sum,el)=>sum+(+el.value||0),0);
    }

    let isSubmitting=false;
    function submitForm(){
      if(isSubmitting) return;
      if(![...document.querySelectorAll('#myForm [required]')].every(f=>f.value.trim())){
        return Swal.fire({icon:'error',title:'‡∏•‡∏∑‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!'});
      }
      isSubmitting=true; document.getElementById('submitButton').disabled=true;
      const fd=new FormData(document.getElementById('myForm'));
      const xhr=new XMLHttpRequest();
      xhr.onreadystatechange=()=>{
        if(xhr.readyState===4){
          if(xhr.status===200){
            Swal.fire({icon:'success',title:'‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'});
            createAndSendFlexMessage(fd);
            document.getElementById('myForm').reset();
            document.getElementById('orderItems').innerHTML='';
            calculateTotal();
          } else {
            Swal.fire({icon:'error',title:'‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤!'});
            document.getElementById('submitButton').disabled=false;
            isSubmitting=false;
          }
        }
      };
      xhr.open('POST','https://script.google.com/macros/s/AKfycbwPndil0dR-LJZraU_GWONXAga1PgHPVOtzInwl_6sW8TMMCkIhsBPbA63vTek9Xq5m/exec');
      xhr.send(fd);
    }

    function createAndSendFlexMessage(fd){
      const customer=fd.get('cust_nm');
      const newCust=fd.get('newCustomer')||'';
      const fTotal=document.getElementById('FTotal').value;
      const credit=fd.get('credit');
      const note=fd.get('note')||'';
      const items=fd.getAll('item_nm[]');
      const qtys=fd.getAll('quantity[]');
      const rates=fd.getAll('price[]');
      const gives=fd.getAll('give[]');
      const dis=fd.getAll('dis[]');
      const smp=fd.getAll('smp[]');
      const amts=fd.getAll('amt[]');

      const orderBoxes=items.map((it,i)=>(
        {type:'box',layout:'vertical',spacing:'sm',margin:'md',contents:[
          {type:'text',text:it,weight:'bold',size:'md'},
          {type:'box',layout:'horizontal',contents:[
            {type:'text',text:`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${qtys[i]}`,wrap:true,flex:3},
            {type:'text',text:`‡∏£‡∏≤‡∏Ñ‡∏≤: ${rates[i]}`,wrap:true,flex:3}
          ]},
          {type:'box',layout:'horizontal',contents:[
            {type:'text',text:`‡πÅ‡∏ñ‡∏°: ${gives[i]}`,wrap:true,flex:3},
            {type:'text',text:`‡∏•‡∏î: ${dis[i]}`,wrap:true,flex:3}
          ]},
          {type:'box',layout:'horizontal',contents:[
            {type:'text',text:`‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°: ${smp[i]}`,wrap:true,flex:3}
          ]},
          {type:'box',layout:'horizontal',contents:[
            {type:'text',text:`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${amts[i]}`,wrap:true,flex:3}
          ]}
        ]}
      ));

      const flex={type:'flex',altText:'‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà',contents:{
        type:'bubble',body:{type:'box',layout:'vertical',spacing:'md',contents:[
          {type:'text',text:'‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',weight:'bold',size:'lg',color:'#067706'},
          {type:'text',text:`‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${customer} ${newCust}`,wrap:true},
          {type:'separator',margin:'sm'},
          {type:'text',text:'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:',weight:'bold',margin:'sm'},
          ...orderBoxes,
          {type:'separator',margin:'sm'},
          {type:'text',text:`‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${fTotal} ‡∏ö‡∏≤‡∏ó`,wrap:true,weight:'bold'},
          {type:'text',text:`‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï: ${credit}`,wrap:true,weight:'bold'},
          {type:'text',text:`‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${note}`,wrap:true,weight:'bold'}
        ]}
      }};

      liff.sendMessages([flex])
        .then(()=>Swal.fire({icon:'success',title:'‡∏™‡πà‡∏á LIFF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',confirmButtonText:'‡∏õ‡∏¥‡∏î'}).then(()=>liff.closeWindow()))
        .catch(console.error);
    }
  </script>
</body>
</html>
