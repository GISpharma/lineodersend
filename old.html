<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GIS รายการสั่งซื้อ</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; color: #333; }
    .main-container { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
    .form-header { 
      background: linear-gradient(135deg, #198754 0%, #0d5f39 100%); 
      color: white; padding: 20px 30px; border-radius: 15px 15px 0 0; 
    }
    .card { border: none; border-radius: 0 0 15px 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .section-title { 
      font-size: 0.95rem; font-weight: 600; color: #198754; 
      margin-bottom: 20px; border-bottom: 2px solid #f0f2f5; padding-bottom: 8px;
    }
    .input-group-text { background-color: #f8f9fa; border-right: none; color: #6c757d; }
    .form-control, .form-select { border-left: none; }
    .form-control:focus, .form-select:focus { box-shadow: none; border-color: #ced4da; }
    
    /* Table Styling */
    .table-responsive { border-radius: 10px; border: 1px solid #eee; }
    .table thead { background-color: #f8f9fa; }
    .bg-amt { background-color: #e8f5e9 !important; font-weight: bold; color: #198754; }
    .btn-submit { padding: 12px; font-weight: 600; border-radius: 10px; }
    .NoPrint button { width: 35px; height: 35px; padding: 0; }
  </style>
</head>
<body>

<div class="container main-container">
  <div class="form-header d-flex justify-content-between align-items-center">
    <div>
      <h4 class="mb-0"><i class="bi bi-file-earmark-medical me-2"></i>บันทึกรายการสั่งซื้อ GISPHARMA</h4>
    </div>
    <div class="text-end d-none d-md-block">
      <small class="opacity-75">Order Management System</small>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-4 p-md-5">
      <form id="myForm">
        
        <div class="section-title"><i class="bi bi-info-circle me-2"></i>ข้อมูลระบบ</div>
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text">OrderID</span>
              <input type="text" id="keyInput" name="order_id" class="form-control bg-light" readonly>
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text">ผู้บันทึก</span>
              <input type="text" id="displayName" name="displayName" class="form-control" required>
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text">UserID</span>
              <input type="text" id="userId" name="userId" class="form-control" value="direct" required>
            </div>
          </div>
        </div>

        <div class="section-title"><i class="bi bi-person-vcard me-2"></i>ข้อมูลลูกค้า</div>
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text">รหัสผู้ขาย</span>
              <input type="text" name="sell_id" class="form-control" required>
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text">ประเภท</span>
              <select name="category" class="form-select" required>
                <option value="">เลือกประเภท</option>
                <option value="ร้านขายยา">ร้านขายยา</option>
                <option value="คลีนิก">คลีนิก</option>
                <option value="โรงพยาบาลรัฐ">โรงพยาบาลรัฐ</option>
                <option value="โรงพยาบาลเอกชน">โรงพยาบาลเอกชน</option>
                <option value="ร้าน/บริษัท/ขายส่ง">ร้าน/บริษัท/ขายส่ง</option>
                <option value="ออนไลน์">ออนไลน์</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text">เลขใบสั่งซื้อ</span>
              <input type="text" name="ipo" class="form-control">
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text">จังหวัด</span>
              <input list="provincesList" id="cityInput" name="city" class="form-control" required>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-5">
          <div class="col-md-9">
            <input type="text" name="cust_nm" class="form-control" style="border-left: 1px solid #ced4da;" placeholder="ชื่อลูกค้า / ชื่อบริษัท" required>
          </div>
          <div class="col-md-3 d-flex align-items-center">
            <div class="form-check form-switch ms-3">
              <input class="form-check-input" type="checkbox" id="newCustomerCheckbox" name="new_customer_flag" value="1">
              <label class="form-check-label ms-2" for="newCustomerCheckbox">ลูกค้าใหม่</label>
            </div>
          </div>
        </div>

        <div class="section-title d-flex justify-content-between align-items-center">
          <span><i class="bi bi-cart-check me-2"></i>รายการสินค้า</span>
          <button type="button" class="btn btn-success btn-sm px-3" onclick="BtnAdd()"><i class="bi bi-plus-lg"></i> เพิ่มรายการ</button>
        </div>
        
        <div class="table-responsive mb-4">
          <table class="table table-hover align-middle">
            <thead class="text-center small">
              <tr>
                <th style="min-width: 250px;">รายการ</th>
                <th style="width: 100px;">จำนวน</th>
                <th style="width: 100px;">ราคา</th>
                <th style="width: 80px;">แถม</th>
                <th style="width: 80px;">ลด</th>
                <th style="width: 100px;">ส.</th>
                <th style="width: 130px;">รวมเงิน</th>
                <th class="NoPrint"></th>
                <th>หมายเหตุ</th>
              </tr>
            </thead>
            <tbody id="TBody">
              <tr id="TRow">
                <td><input list="itemSelect" name="item_nm" class="form-control form-control-sm" style="border-left:1px solid #ced4da"></td>
                <td><input type="number" name="qty" class="form-control form-control-sm text-center" onchange="Calc(this)"></td>
                <td><input type="number" name="rate" class="form-control form-control-sm text-end" onchange="Calc(this)"></td>
                <td><input type="number" name="give" class="form-control form-control-sm text-center" onchange="Calc(this)"></td>
                <td><input type="number" name="dis" class="form-control form-control-sm text-center" onchange="Calc(this)"></td>
                <td><input type="text" name="smp" class="form-control form-control-sm text-center" placeholder="ส."></td>
                <td><input type="number" name="amt" class="form-control form-control-sm text-end bg-amt" readonly></td>
                <td class="NoPrint text-center">
                  <button type="button" class="btn btn-danger btn-sm" onclick="BtnDel(this)"><i class="bi bi-x"></i></button>
                </td>
                <td><input type="text" name="note_nm" class="form-control form-control-sm" placeholder="หมายเหตุ"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="row g-4">
          <div class="col-md-6">
            <div class="p-3 border rounded bg-light h-100">
              <div class="input-group mb-3">
                <span class="input-group-text">เครดิต</span>
                <select name="credit" class="form-select">
                  <option value="">เลือกเครดิต</option>
                  <option value="เงินสด">เงินสด</option>
                  <option value="7 วัน">7 วัน</option>
                  <option value="30 วัน">30 วัน</option>
                  <option value="60 วัน">60 วัน</option>
                  <option value="90 วัน">90 วัน</option>
                  <option value="120 วัน">120 วัน</option>
                </select>
              </div>
              <textarea name="note" class="form-control" style="border-left:1px solid #ced4da" rows="3" placeholder="หมายเหตุท้ายบิล..."></textarea>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 border rounded bg-white shadow-sm h-100 d-flex flex-column justify-content-between">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="h5 mb-0 text-muted">ยอดรวมทั้งหมด</span>
                <div class="text-end">
                  <h2 class="text-success mb-0" id="displayTotal">0.00</h2>
                  <input type="hidden" id="FTotal" name="FTotal">
                </div>
              </div>
              <button type="button" id="submitButton" class="btn btn-success btn-submit w-100" onclick="submitForm()">
                <i class="bi bi-save me-2"></i> ส่งข้อมูลรายการสั่งซื้อ
              </button>
            </div>
          </div>
        </div>

        <div id="loading" class="text-center mt-4" style="display:none">
          <div class="spinner-border text-success mb-2" role="status"></div>
          <div class="small text-muted">กำลังบันทึกข้อมูล กรุณารอสักครู่...</div>
        </div>

      </form>
    </div>
  </div>
</div>

<datalist id="itemSelect">
  <option value="AMCARDIA 5"> <option value="AMCARDIA 10"> <option value="BLOOD LINE">
  <option value="CELOGIS 200(1x10s)"> <option value="CELOGIS 200(10x10s)"> <option value="DICLO SR 100">
  <option value="DOLONIL SR 100"> <option value="ENACE 10"> <option value="ENACE 5 (pack100)(10x10s)">
  <option value="ENACE 5 (pack1000)(100x10s)"> <option value="HEPARIN INJ"> <option value="NITRAZEPAM TABLETS 5 MG">
  <option value="NITRAZEPAM (WORKING STANDARD)"> <option value="HEP-25"> <option value="IRON SUCROSE INJ">
  <option value="METROGYL GEL"> <option value="OFTOP 200"> <option value="OFLO 200">
  <option value="OMLEK 20"> <option value="TENROL 50(50x10s)"> <option value="TENROL 100(50x10)">
  <option value="TENSINIC CD 30"> <option value="MAXAMIN TABLETS (30 TABLETS)"> <option value="BEPLEX TABLETS (30 TABLETS)">
  <option value="DIPSOTREX OINTMENT 30 G"> <option value="BUROFEN 400 (50x10 Tab)"> <option value="VITAMIN C 50 (20x50 Tab)">
  <option value="POVIDINE (12 x 30 ml/Bottle)"> <option value="POVIDINE (12 x 450 ml/Bottle)"> <option value="ZOLEGIS INJ 4 MG/5ML">
</datalist>

<datalist id="provincesList">
  <option value="กรุงเทพมหานคร"> <option value="กระบี่"> <option value="กาญจนบุรี"> <option value="กาฬสินธุ์">
  <option value="กำแพงเพชร"> <option value="ขอนแก่น"> <option value="จันทบุรี"> <option value="ฉะเชิงเทรา">
  <option value="ชลบุรี"> <option value="ชัยนาท"> <option value="ชัยภูมิ"> <option value="ชุมพร">
  <option value="เชียงราย"> <option value="เชียงใหม่"> <option value="ตรัง"> <option value="ตราด">
  <option value="ตาก"> <option value="นครนายก"> <option value="นครปฐม"> <option value="นครพนม">
  <option value="นครราชสีมา"> <option value="นครศรีธรรมราช"> <option value="นครสวรรค์"> <option value="นนทบุรี">
  <option value="นราธิวาส"> <option value="น่าน"> <option value="บึงกาฬ"> <option value="บุรีรัมย์">
  <option value="ปทุมธานี"> <option value="ประจวบคีรีขันธ์"> <option value="ปราจีนบุรี"> <option value="ปัตตานี">
  <option value="พระนครศรีอยุธยา"> <option value="พะเยา"> <option value="พังงา"> <option value="พัทลุง">
  <option value="พิจิตร"> <option value="พิษณุโลก"> <option value="เพชรบุรี"> <option value="เพชรบูรณ์">
  <option value="แพร่"> <option value="ภูเก็ต"> <option value="มหาสารคาม"> <option value="มุกดาหาร">
  <option value="แม่ฮ่องสอน"> <option value="ยโสธร"> <option value="ยะลา"> <option value="ร้อยเอ็ด">
  <option value="ระนอง"> <option value="ระยอง"> <option value="ราชบุรี"> <option value="ลพบุรี">
  <option value="ลำปาง"> <option value="ลำพูน"> <option value="เลย"> <option value="ศรีสะเกษ">
  <option value="สกลนคร"> <option value="สงขลา"> <option value="สตูล"> <option value="สมุทรปราการ">
  <option value="สมุทรสงคราม"> <option value="สมุทรสาคร"> <option value="สระแก้ว"> <option value="สระบุรี">
  <option value="สิงห์บุรี"> <option value="สุโขทัย"> <option value="สุพรรณบุรี"> <option value="สุราษฎร์ธานี">
  <option value="สุรินทร์"> <option value="หนองคาย"> <option value="หนองบัวลำภู"> <option value="อ่างทอง">
  <option value="อำนาจเจริญ"> <option value="อุดรธานี"> <option value="อุตรดิตถ์"> <option value="อุทัยธานี">
  <option value="อุบลราชธานี">
</datalist>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function BtnAdd() {
      const v = $('#TRow').clone().appendTo('#TBody');
      v.removeAttr('id').find('input').val('');
      v.find('.bg-amt').val('0');
    }
    
    function BtnDel(btn) {
      if($('#TBody tr').length > 1) {
        $(btn).closest('tr').remove();
        CalcTotals();
      }
    }

    function Calc(elem) {
      const row = $(elem).closest('tr');
      const q = parseFloat(row.find('input[name=qty]').val()) || 0;
      const r = parseFloat(row.find('input[name=rate]').val()) || 0;
      row.find('input[name=amt]').val((q * r).toFixed(2));
      CalcTotals();
    }

    function CalcTotals() {
      let sum = 0;
      $('input[name=amt]').each((i, el) => sum += parseFloat(el.value) || 0);
      $('#FTotal').val(sum.toFixed(2));
      $('#displayTotal').text(sum.toLocaleString(undefined, {minimumFractionDigits: 2}));
    }

    window.onload = () => {
      const d = new Date(), yy = String(d.getFullYear()).slice(-2), mm = String(d.getMonth()+1).padStart(2,'0');
      $('#keyInput').val(`INV${yy}${mm}-${Math.random().toString(36).slice(2,9).toUpperCase()}`);
    };

    function submitForm(){
      if(!$('input[name="cust_nm"]').val()) {
        Swal.fire('กรุณาระบุชื่อลูกค้า', '', 'warning');
        return;
      }

      $('#submitButton').prop('disabled',true).html('<span class="spinner-border spinner-border-sm"></span> กำลังบันทึก...');
      $('#loading').show();

      const fd = new FormData($('#myForm')[0]);
      $.ajax({
        url: 'https://script.google.com/macros/s/AKfycbwVYEOgtEy0dDJsAmsNDXX8BoGV0tC4KoA4PmKWzJ0EiHDxVAnS1qbE06bJJcSACkvf0w/exec',
        method: 'POST',
        data: fd,
        processData: false,
        contentType: false
      })
      .done(() => {
        Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success').then(() => location.reload());
      })
      .fail(() => {
        Swal.fire('ล้มเหลว', 'ไม่สามารถส่งข้อมูลได้', 'error');
      })
      .always(() => {
        $('#loading').hide();
        $('#submitButton').prop('disabled',false).html('<i class="bi bi-save me-2"></i> บันทึกข้อมูล');
      });
    }
</script>
</body>
</html>
