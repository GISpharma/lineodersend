<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GIS Order System</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    :root { --primary-color: #0d5f39; --secondary-bg: #f8f9fa; }
    body { background-color: #e9ecef; font-family: 'Sarabun', sans-serif; font-size: 14px; }
    
    /* Layout */
    .main-wrapper { max-width: 1300px; margin: 20px auto; }
    .glass-card { 
      background: white; border-radius: 12px; border: none; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden;
    }
    
    /* Header */
    .top-bar { 
      background: var(--primary-color); color: white; 
      padding: 15px 25px; border-bottom: 4px solid #198754;
    }

    /* Sections */
    .content-section { padding: 20px; border-bottom: 1px solid #eee; }
    .section-label { 
      font-weight: 600; color: var(--primary-color); 
      margin-bottom: 15px; display: flex; align-items: center; 
      border-left: 4px solid var(--primary-color); padding-left: 10px;
    }

    /* Form Elements */
    .form-label-sm { font-size: 12px; color: #666; margin-bottom: 4px; }
    .form-control-sm, .form-select-sm { border-radius: 6px; border: 1px solid #ddd; padding: 8px; }
    .input-group-text { background-color: #eee; border-color: #ddd; font-size: 12px; }

    /* Table */
    .table-custom { font-size: 13px; }
    .table-custom thead { background: #f1f3f5; }
    .table-custom th { border: none; padding: 12px 8px; font-weight: 600; color: #495057; }
    .bg-amount { background-color: #f0fff4 !important; font-weight: 700; color: #0d5f39; border: 1px solid #c6f6d5 !important; }

    /* Sidebar / Summary */
    .summary-box { background: var(--secondary-bg); border-radius: 10px; padding: 20px; position: sticky; top: 20px; }
    .total-label { font-size: 14px; color: #666; }
    .total-value { font-size: 28px; font-weight: 700; color: var(--primary-color); }
    
    .btn-save { background: var(--primary-color); color: white; padding: 12px; font-weight: 600; border-radius: 8px; transition: 0.3s; }
    .btn-save:hover { background: #0a4b2d; transform: translateY(-2px); color: white; }
  </style>
</head>
<body>

<div class="main-wrapper container-fluid">
  <div class="glass-card">
    <div class="top-bar d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-bold"><i class="bi bi-box-seam me-2"></i>บันทึกรายการสั่งซื้อ GISPHARMA</h5>
      <div id="dateDisplay" class="small opacity-75"></div>
    </div>

    <form id="myForm">
      <div class="row g-0">
        <div class="col-lg-9 border-end">
          
          <div class="content-section bg-light">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label-sm">OrderID</label>
                <input type="text" id="keyInput" name="order_id" class="form-control form-control-sm" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label-sm">เจ้าหน้าที่บันทึก</label>
                <input type="text" id="displayName" name="displayName" class="form-control form-control-sm" required>
              </div>
              <div class="col-md-3">
                <label class="form-label-sm">UserID</label>
                <input type="text" id="userId" name="userId" class="form-control form-control-sm" value="direct">
              </div>
              <div class="col-md-3">
                <label class="form-label-sm">เลขใบสั่งซื้อ (IPO)</label>
                <input type="text" name="ipo" class="form-control form-control-sm" placeholder="ถ้ามี">
              </div>
            </div>
          </div>

          <div class="content-section">
            <div class="section-label">ข้อมูลลูกค้า</div>
            <div class="row g-3">
              <div class="col-md-2">
                <label class="form-label-sm">รหัสผู้ขาย</label>
                <input type="text" name="sell_id" class="form-control form-control-sm" required>
              </div>
              <div class="col-md-3">
                <label class="form-label-sm">ประเภทลูกค้า</label>
                <select name="category" class="form-select form-select-sm" required>
                  <option value="">เลือกประเภท...</option>
                  <option value="ร้านขายยา">ร้านขายยา</option>
                  <option value="คลีนิก">คลีนิก</option>
                  <option value="โรงพยาบาลรัฐ">โรงพยาบาลรัฐ</option>
                  <option value="โรงพยาบาลเอกชน">โรงพยาบาลเอกชน</option>
                  <option value="ร้าน/บริษัท/ขายส่ง">ร้าน/บริษัท/ขายส่ง</option>
                  <option value="ออนไลน์">ออนไลน์</option>
                </select>
              </div>
              <div class="col-md-5">
                <label class="form-label-sm">ชื่อลูกค้า/ชื่อร้าน</label>
                <input type="text" name="cust_nm" class="form-control form-control-sm" required placeholder="ระบุชื่อเต็ม">
              </div>
              <div class="col-md-2">
                <label class="form-label-sm">จังหวัด</label>
                <input list="provincesList" name="city" class="form-control form-control-sm" required>
              </div>
              <div class="col-12 mt-2 text-end">
                <div class="form-check form-switch d-inline-block">
                  <input class="form-check-input" type="checkbox" id="newCustomerCheckbox" name="new_customer_flag" value="1">
                  <label class="form-check-label" for="newCustomerCheckbox">ลูกค้าใหม่</label>
                </div>
              </div>
            </div>
          </div>

          <div class="content-section">
            <div class="section-label d-flex justify-content-between">
              <span>รายการสินค้า</span>
              <button type="button" class="btn btn-outline-success btn-sm" onclick="BtnAdd()"><i class="bi bi-plus-circle me-1"></i>เพิ่มแถว</button>
            </div>
            <div class="table-responsive">
              <table class="table table-custom align-middle">
                <thead>
                  <tr class="text-center">
                    <th style="width: 30%;">ชื่อสินค้า</th>
                    <th style="width: 10%;">จำนวน</th>
                    <th style="width: 12%;">ราคา/หน่วย</th>
                    <th style="width: 8%;">แถม</th>
                    <th style="width: 8%;">ลด</th>
                    <th style="width: 15%;">รวมเงิน</th>
                    <th style="width: 12%;">หมายเหตุ</th>
                    <th style="width: 5%;"></th>
                  </tr>
                </thead>
                <tbody id="TBody">
                  <tr id="TRow">
                    <td><input list="itemSelect" name="item_nm" class="form-control form-control-sm"></td>
                    <td><input type="number" name="qty" class="form-control form-control-sm text-center" onchange="Calc(this)"></td>
                    <td><input type="number" name="rate" class="form-control form-control-sm text-end" onchange="Calc(this)"></td>
                    <td><input type="number" name="give" class="form-control form-control-sm text-center" onchange="Calc(this)"></td>
                    <td><input type="number" name="dis" class="form-control form-control-sm text-center" onchange="Calc(this)"></td>
                    <td><input type="number" name="amt" class="form-control form-control-sm text-end bg-amount" readonly></td>
                    <td><input type="text" name="note_nm" class="form-control form-control-sm" placeholder="..."></td>
                    <td class="text-center">
                      <button type="button" class="btn btn-link text-danger p-0" onclick="BtnDel(this)"><i class="bi bi-trash-fill"></i></button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-3">
          <div class="summary-box h-100">
            <div class="section-label">สรุปใบสั่งซื้อ</div>
            
            <div class="mb-4">
              <label class="form-label-sm">เงื่อนไขเครดิต</label>
              <select name="credit" class="form-select form-select-sm mb-3">
                <option value="">เลือกการชำระเงิน...</option>
                <option value="เงินสด">เงินสด</option>
                <option value="7 วัน">7 วัน</option>
                <option value="30 วัน">30 วัน</option>
                <option value="60 วัน">60 วัน</option>
                <option value="90 วัน">90 วัน</option>
                <option value="120 วัน">120 วัน</option>
              </select>

              <label class="form-label-sm">หมายเหตุท้ายบิล</label>
              <textarea name="note" class="form-control form-control-sm" rows="4" placeholder="ระบุรายละเอียดเพิ่มเติม..."></textarea>
            </div>

            <hr>

            <div class="text-end mb-4">
              <div class="total-label">ยอดรวมสุทธิ (Net Total)</div>
              <div class="total-value" id="displayTotal">0.00</div>
              <input type="hidden" id="FTotal" name="FTotal">
            </div>

            <button type="button" id="submitButton" class="btn btn-save w-100" onclick="submitForm()">
              <i class="bi bi-check-circle me-2"></i>ยืนยันและบันทึก
            </button>

            <div id="loading" class="text-center mt-3" style="display:none">
              <div class="spinner-border spinner-border-sm text-success" role="status"></div>
              <span class="ms-2 text-muted">กำลังส่งข้อมูล...</span>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<datalist id="itemSelect">
  <option value="AMCARDIA 5"> <option value="AMCARDIA 10"> <option value="BLOOD LINE">
  <option value="CELOGIS 200(1x10s)"> <option value="CELOGIS 200(10x10s)"> <option value="DICLO SR 100">
  <option value="DOLONIL SR 100"> <option value="ENACE 10"> <option value="ENACE 5 (pack100)(10x10s)">
  <option value="ENACE 5 (pack1000)(100x10s)"> <option value="HEPARIN INJ"> <option value="NITRAZEPAM TABLETS 5 MG">
  <option value="NITRAZEPAM (WORKING STANDARD)"> <option value="HEP-25"> <option value="IRON SUCROSE INJ">
  <option value="METROGYL GEL"> <option value="OFTOP 200"> <option value="OFLO 200">
  <option value="OMLEK 20"> <option value="TENROL 50(50x10s)"> <option value="TENROL 100(50x10)">
  <option value="TENSINIC CD 30"> <option value="MAXAMIN TABLETS (30 TABLETS)"> <option value="BEPLEX TABLETS (30 TABLETS)">
  <option value="DIPSOTREX OINTMENT 30 G"> <option value="BUROFEN 400 (50x10 Tab)"> <option value="VITAMIN C 50 (20x50 Tab)">
  <option value="POVIDINE (12 x 30 ml/Bottle)"> <option value="POVIDINE (12 x 450 ml/Bottle)"> <option value="ZOLEGIS INJ 4 MG/5ML">
</datalist>

<datalist id="provincesList">
  <option value="กรุงเทพมหานคร"> <option value="กระบี่"> <option value="กาญจนบุรี"> <option value="กาฬสินธุ์">
  <option value="กำแพงเพชร"> <option value="ขอนแก่น"> <option value="จันทบุรี"> <option value="ฉะเชิงเทรา">
  <option value="ชลบุรี"> <option value="ชัยนาท"> <option value="ชัยภูมิ"> <option value="ชุมพร">
  <option value="เชียงราย"> <option value="เชียงใหม่"> <option value="ตรัง"> <option value="ตราด">
  <option value="ตาก"> <option value="นครนายก"> <option value="นครปฐม"> <option value="นครพนม">
  <option value="นครราชสีมา"> <option value="นครศรีธรรมราช"> <option value="นครสวรรค์"> <option value="นนทบุรี">
  <option value="นราธิวาส"> <option value="น่าน"> <option value="บึงกาฬ"> <option value="บุรีรัมย์">
  <option value="ปทุมธานี"> <option value="ประจวบคีรีขันธ์"> <option value="ปราจีนบุรี"> <option value="ปัตตานี">
  <option value="พระนครศรีอยุธยา"> <option value="พะเยา"> <option value="พังงา"> <option value="พัทลุง">
  <option value="พิจิตร"> <option value="พิษณุโลก"> <option value="เพชรบุรี"> <option value="เพชรบูรณ์">
  <option value="แพร่"> <option value="ภูเก็ต"> <option value="มหาสารคาม"> <option value="มุกดาหาร">
  <option value="แม่ฮ่องสอน"> <option value="ยโสธร"> <option value="ยะลา"> <option value="ร้อยเอ็ด">
  <option value="ระนอง"> <option value="ระยอง"> <option value="ราชบุรี"> <option value="ลพบุรี">
  <option value="ลำปาง"> <option value="ลำพูน"> <option value="เลย"> <option value="ศรีสะเกษ">
  <option value="สกลนคร"> <option value="สงขลา"> <option value="สตูล"> <option value="สมุทรปราการ">
  <option value="สมุทรสงคราม"> <option value="สมุทรสาคร"> <option value="สระแก้ว"> <option value="สระบุรี">
  <option value="สิงห์บุรี"> <option value="สุโขทัย"> <option value="สุพรรณบุรี"> <option value="สุราษฎร์ธานี">
  <option value="สุรินทร์"> <option value="หนองคาย"> <option value="หนองบัวลำภู"> <option value="อ่างทอง">
  <option value="อำนาจเจริญ"> <option value="อุดรธานี"> <option value="อุตรดิตถ์"> <option value="อุทัยธานี">
  <option value="อุบลราชธานี">
</datalist>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // System Functions
    window.onload = () => {
      const d = new Date();
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      $('#dateDisplay').text(d.toLocaleDateString('th-TH', options));
      
      const yy = String(d.getFullYear()).slice(-2), mm = String(d.getMonth()+1).padStart(2,'0');
      $('#keyInput').val(`INV${yy}${mm}-${Math.random().toString(36).slice(2,8).toUpperCase()}`);
    };

    function BtnAdd() {
      const v = $('#TRow').clone().appendTo('#TBody');
      v.removeAttr('id').find('input').val('');
      v.find('.bg-amount').val('0');
    }

    function BtnDel(btn) {
      if($('#TBody tr').length > 1) {
        $(btn).closest('tr').remove();
        CalcTotals();
      }
    }

    function Calc(elem) {
      const row = $(elem).closest('tr');
      const q = parseFloat(row.find('input[name=qty]').val()) || 0;
      const r = parseFloat(row.find('input[name=rate]').val()) || 0;
      row.find('input[name=amt]').val((q * r).toFixed(2));
      CalcTotals();
    }

    function CalcTotals() {
      let sum = 0;
      $('input[name=amt]').each((i, el) => sum += parseFloat(el.value) || 0);
      $('#FTotal').val(sum.toFixed(2));
      $('#displayTotal').text(sum.toLocaleString(undefined, {minimumFractionDigits: 2}));
    }

    function submitForm(){
      if(!$('input[name="cust_nm"]').val() || !$('input[name="sell_id"]').val()) {
        Swal.fire('กรุณากรอกข้อมูลสำคัญ', 'รหัสผู้ขาย และชื่อลูกค้า ห้ามว่าง', 'warning');
        return;
      }

      $('#submitButton').prop('disabled',true).html('<span class="spinner-border spinner-border-sm"></span> บันทึกข้อมูล...');
      $('#loading').show();

      const fd = new FormData($('#myForm')[0]);
      $.ajax({
        url: 'https://script.google.com/macros/s/AKfycbwVYEOgtEy0dDJsAmsNDXX8BoGV0tC4KoA4PmKWzJ0EiHDxVAnS1qbE06bJJcSACkvf0w/exec',
        method: 'POST',
        data: fd,
        processData: false,
        contentType: false
      })
      .done(() => {
        Swal.fire({
          icon: 'success', title: 'บันทึกสำเร็จ',
          text: 'ข้อมูลถูกบันทึกเรียบร้อย',
          confirmButtonColor: '#0d5f39'
        }).then(() => location.reload());
      })
      .fail(() => {
        Swal.fire('ล้มเหลว', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้', 'error');
      })
      .always(() => {
        $('#loading').hide();
        $('#submitButton').prop('disabled',false).html('<i class="bi bi-check-circle me-2"></i>ยืนยันและบันทึก');
      });
    }
</script>
</body>
</html>
