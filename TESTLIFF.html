<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Notification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <form id="orderForm">
            <div class="card p-3">
                <div class="mb-3">
                    <label for="displayName" class="form-label">Customer Name</label>
                    <input type="text" id="displayName" name="displayName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="sell_id" class="form-label">Seller ID</label>
                    <input type="number" class="form-control" name="sell_id" required>
                </div>
                <div class="mb-3">
                    <label for="category" class="form-label">Customer Type</label>
                    <select id="category" name="category" class="form-select" required>
                        <option value="">Select Type</option>
                        <option value="Pharmacy">Pharmacy</option>
                        <option value="Clinic">Clinic</option>
                        <option value="Public Hospital">Public Hospital</option>
                        <option value="Private Hospital">Private Hospital</option>
                        <option value="Retail/Wholesale">Retail/Wholesale</option>
                        <option value="Online">Online</option>
                    </select>
                </div>
                <div id="orderItems"></div>
                <button type="button" class="btn btn-outline-success mb-3" onclick="addOrderItem()">Add Order Item</button>
                <div class="mb-3">
                    <label for="FTotal" class="form-label">Total Amount</label>
                    <input type="number" class="form-control bg-light" id="FTotal" name="FTotal" readonly>
                </div>
                <div class="mb-3">
                    <label for="credit" class="form-label">Credit</label>
                    <select class="form-select" name="credit" required>
                        <option value="">Select Credit</option>
                        <option value="Cash">Cash</option>
                        <option value="7 days">7 days</option>
                        <option value="30 days">30 days</option>
                        <option value="60 days">60 days</option>
                        <option value="90 days">90 days</option>
                        <option value="120 days">120 days</option>
                    </select>
                </div>
                <div class="mb-3">
                    <textarea class="form-control" placeholder="Notes" name="note"></textarea>
                </div>
                <button id="submitButton" class="btn btn-success w-100" type="button" onclick="submitForm()">Submit</button>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.all.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            initializeLiff();
        });

        const initializeLiff = async () => {
            try {
                await liff.init({ liffId: '1660766925-qDv7zvV5' });

                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
            }
        };

        const getUserProfile = async () => {
            try {
                const profile = await liff.getProfile();
                document.getElementById('displayName').value = profile.displayName;
            } catch (error) {
                console.error('Error getting profile data:', error);
            }
        };

        const addOrderItem = () => {
            const orderItems = document.getElementById("orderItems");
            const newItem = document.createElement("div");
            newItem.className = "card p-3 mb-3";
            newItem.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="item_nm[]" class="form-label">Item Name</label>
                        <input list="items" class="form-control" name="item_nm[]" required>
                        <datalist id="items">
                            <option value="Item 1">
                            <option value="Item 2">
                            <option value="Item 3">
                        </datalist>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="quantity[]" class="form-label">Quantity</label>
                        <input type="number" name="quantity[]" class="form-control" onchange="calculateAmount(this);" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="price[]" class="form-label">Price</label>
                        <input type="number" name="price[]" class="form-control" onchange="calculateAmount(this);" required>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="button" class="btn btn-danger" onclick="removeOrderItem(this)">Remove</button>
                    </div>
                </div>`;
            orderItems.appendChild(newItem);
        };

        const removeOrderItem = (button) => {
            button.closest('.card').remove();
            calculateTotal();
        };

        const calculateAmount = (input) => {
            const item = input.closest('.row');
            const quantity = item.querySelector('input[name="quantity[]"]').value || 0;
            const price = item.querySelector('input[name="price[]"]').value || 0;
            const amount = quantity * price;
            calculateTotal();
        };

        const calculateTotal = () => {
            const quantities = document.querySelectorAll('input[name="quantity[]"]');
            const prices = document.querySelectorAll('input[name="price[]"]');
            let total = 0;
            for (let i = 0; i < quantities.length; i++) {
                total += (parseFloat(quantities[i].value) || 0) * (parseFloat(prices[i].value) || 0);
            }
            document.getElementById("FTotal").value = total;
        };

        const submitForm = () => {
            const form = document.getElementById("orderForm");
            const formData = new FormData(form);
            const customer = formData.get("displayName");
            const fTotal = document.getElementById("FTotal").value;
            const credit = formData.get("credit");
            const notes = formData.get("note") || "";

            // Gather order items
            const orderItems = [];
            const itemNames = formData.getAll("item_nm[]");
            const quantities = formData.getAll("quantity[]");
            const prices = formData.getAll("price[]");

            for (let i = 0; i < itemNames.length; i++) {
                orderItems.push({
                    itemName: itemNames[i],
                    qty: quantities[i],
                    rate: prices[i],
                    amt: (quantities[i] * prices[i]).toFixed(2)
                });
            }

            const flexMessage = {
                type: "flex",
                altText: "มีคำสั่งซื้อใหม่",
                contents: {
                    type: "bubble",
                    body: {
                        type: "box",
                        layout: "vertical",
                        spacing: "md",
                        contents: [
                            { type: "text", text: "แจ้งการสั่งซื้อ", wrap: true, weight: "bold", size: "lg" },
                            { type: "text", text: `ลูกค้า: ${customer}`, wrap: true },
                            { type: "separator", margin: "sm" },
                            { type: "text", text: "รายการสินค้า:", weight: "bold", margin: "sm" },
                            ...orderItems.map(item => ({
                                type: "box",
                                layout: "vertical",
                                spacing: "sm",
                                margin: "md",
                                contents: [
                                    {
                                        type: "box",
                                        layout: "horizontal",
                                        flex: 1,
                                        contents: [
                                            { type: "text", text: item.itemName, weight: "bold", size: "md" }
                                        ]
                                    },
                                    {
                                        type: "box",
                                        layout: "horizontal",
                                        flex: 1,
                                        contents: [
                                            { type: "text", text: `จำนวน: ${item.qty}`, wrap: true, flex: 3 },
                                            { type: "text", text: `ราคา: ${item.rate}`, wrap: true, flex: 3 }
                                        ]
                                    },
                                    {
                                        type: "box",
                                        layout: "horizontal",
                                        flex: 1,
                                        contents: [
                                            { type: "text", text: `จำนวนเงิน: ${item.amt}`, wrap: true, flex: 3 }
                                        ]
                                    }
                                ]
                            })),
                            { type: "separator", margin: "sm" },
                            { type: "text", text: `ยอดรวมทั้งสิ้น: ${fTotal} บาท`, wrap: true, weight: "bold" },
                            { type: "separator", margin: "sm" },
                            { type: "text", text: `เครดิต: ${credit}`, wrap: true, weight: "bold" },
                            { type: "separator", margin: "sm" },
                            { type: "text", text: `หมายเหตุ: ${notes}`, wrap: true, weight: "bold" }
                        ]
                    }
                }
            };

            sendLIFFMessage(flexMessage);
        };

        const sendLIFFMessage = (flexMessage) => {
            liff.sendMessages([flexMessage])
                .then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'สำเร็จ!',
                        text: 'ส่งข้อมูลสำเร็จแล้ว',
                        confirmButtonText: 'ปิด'
                    }).then(() => {
                        liff.closeWindow();
                    });
                })
                .catch(error => {
                    console.error('Error sending LIFF message:', error);
                });
        };
    </script>
</body>
</html>
